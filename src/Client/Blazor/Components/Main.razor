@inject IChatClient ChatClient
@inject ISessionStorageService SessionStore

<PeopleList
  IsLoading="@_isLoadingPeople"
  People="@_people"
  ClickPerson="OnClickPerson"
/>
<MessageList
  IsLoading="@_isLoadingRecipient"
  Recipient="@_recipient"
/>

@code {
    private bool _isLoadingPeople = true;
    private bool _isLoadingRecipient = false;
    private IPersonConnection? _people;
    private IRecipient? _recipient;

    [Parameter]
    public EventCallback ClickSignOut { get; set; }

    [Parameter]
    public IPerson User { get; set; } = default(IPerson);

    protected override async Task OnInitializedAsync()
    {
        var recipientId = await SessionStore.GetItemAsync<string>("RecipientId");

        if (recipientId == string.Empty)
        {
            await LoadPeople(string.Empty);
        }
        else
        {
            await LoadPeopleAndRecipient(string.Empty, recipientId);
        }

        _isLoadingPeople = false;
        StateHasChanged();
    }

    private async Task OnClickPerson(IPerson user)
    {
        var operation = await ChatClient.GetRecipientAsync(user.Id);

        if (operation.HasErrors)
        {
            // todo: error handling
        }

        _recipient = operation.Data?.PersonById;

        if (_recipient == null)
        {
            await SessionStore.RemoveItemAsync("RecipientId");
        }
        else
        {
            await SessionStore.SetItemAsync("RecipientId", _recipient.Id);
        }
    }

    private async Task LoadPeople(string userId)
    {
        var operation = await ChatClient.GetPeopleAsync();//userId);

        if (operation.HasErrors)
        {
            // todo: error handling
        }
        
        _people = operation.Data?.People;
    }

    private async Task LoadPeopleAndRecipient(string userId, string recipientId)
    {
        var operation = await ChatClient.GetPeopleAndRecipientAsync(recipientId);//userId, recipientId);

        if (operation.HasErrors)
        {
            // todo: error handling

            var firstError = operation.Errors[0];
            
            if (firstError.Exception != null &&
                firstError.Extensions.ContainsKey("code") &&
                firstError.Extensions["code"].ToString() == "EXEC_NON_NULL_VIOLATION")
            {
                await SessionStore.RemoveItemAsync("RecipientId");
                await LoadPeople(string.Empty);
            }
        }
        
        _people = operation.Data?.People;
        _recipient = operation.Data?.PersonById;
    }
}